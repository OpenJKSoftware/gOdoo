# PostgreSQL 17 - Odoo 16 Staging
# 4-core HyperV VM, 23GB RAM shared with prod+plausible
# Staging is rarely used - minimal resource allocation

# CONNECTION
# Few concurrent users expected
max_connections = 40
superuser_reserved_connections = 2
max_files_per_process = 100

# MEMORY (Minimal: ~500MB allocation)
# Staging should be lean - just enough to function
shared_buffers = 256MB
effective_cache_size = 512MB
maintenance_work_mem = 64MB
work_mem = 8MB
hash_mem_multiplier = 2.0

# WAL & CHECKPOINT
wal_buffers = 8MB
min_wal_size = 256MB
max_wal_size = 1GB
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# PARALLELISM (Minimal - don't compete with prod)
max_worker_processes = 2
max_parallel_workers_per_gather = 0
max_parallel_workers = 1
max_parallel_maintenance_workers = 1

# I/O (NVMe)
random_page_cost = 1.1
effective_io_concurrency = 50
maintenance_io_concurrency = 25

# PLANNER
default_statistics_target = 50
jit = off

# BGWRITER
bgwriter_delay = 500ms
bgwriter_lru_maxpages = 50
bgwriter_lru_multiplier = 2.0

# AUTOVACUUM (Less aggressive for staging)
autovacuum = on
autovacuum_max_workers = 1
autovacuum_naptime = 60s
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 200

# TRANSACTION
max_prepared_transactions = 0

# LOGGING
log_line_prefix = '%m [%p-%l] %u@%d app=%a '
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
# More verbose for debugging staging issues
log_min_duration_statement = 1000
track_io_timing = on

# PERFORMANCE
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 1000

# ODOO TUNING
statement_timeout = 0
lock_timeout = 30000
idle_in_transaction_session_timeout = 600000
