worker_processes  4;
# user www-data;
pid /var/log/nginx/nginx.pid;
error_log /var/log/nginx/error.log info;

events {
    use           epoll;
    worker_connections  1000;
    multi_accept on;  # Accept multiple connections at once
}

http {
    include /etc/nginx/mime.types;
    server_tokens off;

    # Performance: Buffering and keepalive
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;

    # Performance: Buffer sizes for Odoo's large responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Gzip compression (moved here for all responses)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript application/x-javascript text/javascript image/svg+xml;

    #odoo server
    upstream odoo {
        server 127.0.0.1:8069;
        keepalive 32;  # Keep connections to Odoo open
    }
    upstream odoochat {
        server 127.0.0.1:8072;
        keepalive 8;
    }
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    map $sent_http_content_type $content_type_csp {
        default "";
        ~image/ "default-src 'none'";
    }

    set_real_ip_from 10.1.0.0/16;
    set_real_ip_from 172.20.0.0/24;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    server {
        listen 80;

        proxy_read_timeout 720s;
        proxy_connect_timeout 720s;
        proxy_send_timeout 720s;
        client_max_body_size 4G; # Set the maximum upload size to 4 gigabytes

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';

        # Redirect websocket requests to odoo gevent port
        location /websocket {
            proxy_pass http://odoochat;
            include /etc/nginx/proxy_headers.conf;
        }

        # Redirect requests to odoo backend server
        location / {
            proxy_pass http://odoo;
            proxy_redirect off;
            include /etc/nginx/proxy_headers.conf;
        }
        location @odoo {
            proxy_pass http://odoo;
            proxy_redirect off;
            include /etc/nginx/proxy_headers.conf;
        }

        location ~ ^/[^/]+/static/.+$ {
            root /odoo;
            # We could figure out a way to automagically adapt this try_files to also include thirdparty addons
            try_files /godoo_workspace/addons$uri /odoo/addons$uri /odoo/odoo/addons$uri /thirdparty/OE_odoo-enterprise$uri /thirdparty/custom/single_mods$uri $uri @odoo;
            expires 7d;
            access_log off;
            include  /etc/nginx/mime.types;
            add_header Content-Security-Policy $content_type_csp;
            add_header Cache-Control "public";
        }

        location /web/filestore {
            internal;
            alias /var/lib/odoo/filestore;
        }

        # Cache web assets (JS/CSS bundles) - Odoo uses cache-busting URLs
        location ~* /web/assets/ {
            proxy_pass http://odoo;
            proxy_redirect off;
            include /etc/nginx/proxy_headers.conf;
            expires 7d;
            access_log off;
            add_header Cache-Control "public";
        }

    }

}
